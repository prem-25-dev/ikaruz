"use strict";

(function(window){

function getTriangleHeight(angle, size){
  var slope = Math.tan(0.017453 * Math.abs(angle));
  return Math.ceil(size * slope);
}

function hexToRgb(hex){
  var result;
  if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
    result = hex.substring(1).split("");
    if(result.length === 3){
      result = [result[0],result[0],result[1],result[1],result[2],result[2]];
    }
    result = "0x" + result.join("");
    return {
      r:(result>>16)&255,
      g:(result>>8)&255,
      b:result&255
    };
  }
  return {r:0,g:0,b:0};
}

/* PARTICLE */

class Particle{

  constructor(color, quadrant, options){

    this.o = options;
    this.color = hexToRgb(color);
    this.direction = Math.random()>0.5?1:-1;

    this.shape = options.shapes[
      Math.floor(Math.random()*options.shapes.length)
    ];

    this.size = Math.abs(this.randomRange(options.size));

    this.setStartPosition(quadrant);

    this.vx = this.randomRange(options.speed.x)*this.direction;
    this.vy = this.randomRange(options.speed.y)*this.direction;
  }

  randomRange(range){
    if(range.min === range.max) return range.min;
    return Math.random()*(range.max-range.min)+range.min;
  }

  setStartPosition(q){

    var halfW = this.o.c.w/2;
    var halfH = this.o.c.h/2;

    var x = Math.random()*halfW;
    var y = Math.random()*halfH;

    if(q===3){ this.x=x+halfW; this.y=y; return; }
    if(q===2){ this.x=x; this.y=y+halfH; return; }
    if(q===1){ this.x=x+halfW; this.y=y+halfH; return; }

    this.x=x; this.y=y;
  }

  rgba(rgb,alpha){
    return `rgba(${rgb.r},${rgb.g},${rgb.b},${alpha})`;
  }

  animate(ctx,w,h){

    this.x+=this.vx;
    this.y+=this.vy;

    if(this.x<0||this.x>w) this.vx*=-1;
    if(this.y<0||this.y>h) this.vy*=-1;

    ctx.beginPath();

    if(this.o.blending && this.o.blending!=="none"){
      ctx.globalCompositeOperation = this.o.blending;
    }

    var gradient = ctx.createRadialGradient(
      this.x,this.y,0.01,
      this.x,this.y,this.size
    );

    gradient.addColorStop(0,this.rgba(this.color,this.o.opacity.center));
    gradient.addColorStop(1,this.rgba(this.color,this.o.opacity.edge));

    ctx.fillStyle = gradient;

    ctx.arc(this.x,this.y,this.size/2,0,Math.PI*2,false);

    ctx.closePath();
    ctx.fill();
  }
}

/* MAIN */

class FinisherHeader{

  constructor(options){

    this.o = options;

    this.canvas = document.createElement("canvas");
    this.ctx = this.canvas.getContext("2d");

    this.canvas.id = "finisher-canvas";

    this.getContainer().appendChild(this.canvas);

    window.addEventListener("resize",()=>{
      clearTimeout(this.resizeTimeout);
      this.resizeTimeout=setTimeout(()=>this.resize(),150);
    });

    this.init();

    requestAnimationFrame(()=>this.animate());
  }

  getContainer(){

    var elements = document.getElementsByClassName(
      this.o.className || "finisher-header"
    );

    if(!elements.length){
      throw new Error("No .finisher-header element found");
    }

    return elements[0];
  }

  resize(){

    var el=this.getContainer();

    this.o.c={ w:el.clientWidth, h:el.clientHeight };

    this.canvas.width=this.o.c.w;
    this.canvas.height=this.o.c.h;

    var skewOffset=getTriangleHeight(this.o.skew,this.o.c.w/2);

    var transform=`skewY(${this.o.skew}deg) translateY(-${skewOffset}px)`;

    this.canvas.style.cssText=
      `position:absolute;z-index:-1;top:0;left:0;right:0;bottom:0;
       transform:${transform};
       background-color:rgba(${this.bg.r},${this.bg.g},${this.bg.b},1);`;
  }

  init(){

    this.bg = hexToRgb(this.o.colors.background);

    this.particles=[];

    this.resize();

    this.createParticles();
  }

  createParticles(){

    var colorIndex=0;

    this.particles=[];

    this.o.activeCount =
      window.innerWidth<600 && this.o.count>5
        ? Math.round(this.o.count/2)
        : this.o.count;

    for(let i=0;i<this.o.activeCount;i++){

      let quadrant=i%4;

      let p = new Particle(
        this.o.colors.particles[colorIndex],
        quadrant,
        this.o
      );

      colorIndex++;
      if(colorIndex>=this.o.colors.particles.length) colorIndex=0;

      this.particles.push(p);
    }
  }

  animate(){

    requestAnimationFrame(()=>this.animate());

    this.ctx.clearRect(0,0,this.o.c.w,this.o.c.h);

    for(let p of this.particles){
      p.animate(this.ctx,this.o.c.w,this.o.c.h);
    }
  }
}

window.FinisherHeader = FinisherHeader;

})(window);